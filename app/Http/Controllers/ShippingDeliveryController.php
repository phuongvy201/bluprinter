<?php

namespace App\Http\Controllers;

use App\Models\DomainShippingCost;
use App\Models\ShippingRate;
use App\Services\CurrencyService;
use Illuminate\Http\Request;

class ShippingDeliveryController extends Controller
{
    /**
     * Display the shipping & delivery page
     */
    public function index()
    {
        $domain = CurrencyService::getCurrentDomain();
        $currency = CurrencyService::getCurrencyForDomain($domain);
        $currencyRate = CurrencyService::getCurrencyRateForDomain($domain) ?? 1.0;

        // Get region from domain
        $region = DomainShippingCost::getRegionFromDomain($domain);

        // Lấy toàn bộ phí ship cho domain hiện tại và phí general (domain null)
        $shippingCosts = DomainShippingCost::where('is_active', true)
            ->where(function ($query) use ($domain) {
                $query->where('domain', $domain)
                    ->orWhereNull('domain');
            })
            ->orderBy('region')
            ->orderBy('product_type')
            ->get();

        // Nếu chưa có dữ liệu DomainShippingCost, fallback sang ShippingRate (ưu tiên theo domain)
        if ($shippingCosts->isEmpty()) {
            $shippingRates = ShippingRate::where(function ($query) use ($domain) {
                if ($domain) {
                    // Ưu tiên domain hiện tại
                    $query->where(function ($q) use ($domain) {
                        $q->where('domain', $domain)
                            ->orWhereJsonContains('domains', $domain);
                    })
                        // Lấy thêm general (domain null) làm fallback nhưng không trộn domain khác
                        ->orWhere(function ($q) {
                            $q->whereNull('domain')
                                ->orWhereNull('domains');
                        });
                } else {
                    // Không có domain: chỉ lấy general
                    $query->whereNull('domain')
                        ->orWhereNull('domains');
                }
            })
                ->where('is_active', true)
                ->whereNotNull('first_item_cost')
                ->whereNotNull('additional_item_cost')
                ->with(['category', 'shippingZone'])
                ->orderBy('sort_order')
                ->get();

            // Chuyển ShippingRate thành cấu trúc DomainShippingCost tương ứng
            $shippingCosts = $shippingRates->map(function ($rate) {
                $productType = 'general';
                if ($rate->category) {
                    $productType = strtolower(str_replace(' ', '_', $rate->category->name));
                } elseif ($rate->name) {
                    $productType = strtolower(str_replace(' ', '_', $rate->name));
                }

                // Xác định region từ shipping zone (nếu có)
                $detectedRegion = null;
                if ($rate->shippingZone) {
                    $zone = $rate->shippingZone;
                    $countries = $zone->countries ?? [];
                    $zoneName = strtolower($zone->name ?? '');

                    $detectedRegion = $this->getRegionFromCountries($countries, $detectedRegion);
                    $detectedRegion = $this->getRegionFromZoneName($zoneName, $detectedRegion);
                }

                return (object) [
                    'region' => $detectedRegion,
                    'product_type' => $productType,
                    'first_item_cost' => (float) $rate->first_item_cost,
                    'additional_item_cost' => (float) $rate->additional_item_cost,
                    'delivery_min_days' => $rate->delivery_min_days,
                    'delivery_max_days' => $rate->delivery_max_days,
                    'delivery_note' => $rate->delivery_note,
                    'is_active' => $rate->is_active,
                ];
            })->filter(function ($cost) {
                // Bỏ các rate không xác định được region
                return !empty($cost->region);
            });
        }

        // Ưu tiên: nếu trong cùng region có sản phẩm cụ thể, ẩn general; mỗi product_type chỉ giữ rate ưu tiên (thấp nhất first_item_cost, rồi additional)
        $shippingCosts = $shippingCosts
            ->filter(fn($c) => !empty($c->region)) // đảm bảo có region
            ->groupBy('region')
            ->flatMap(function ($itemsByRegion) {
                // Nếu có product_type khác 'general', bỏ hết 'general'
                $hasSpecific = $itemsByRegion->contains(function ($c) {
                    return $c->product_type !== 'general';
                });
                if ($hasSpecific) {
                    $itemsByRegion = $itemsByRegion->filter(fn($c) => $c->product_type !== 'general');
                }

                // Mỗi product_type chọn 1 rate ưu tiên (cost thấp nhất)
                return $itemsByRegion->groupBy('product_type')->map(function ($group) {
                    return $group->sortBy([
                        ['first_item_cost', 'asc'],
                        ['additional_item_cost', 'asc'],
                    ])->first();
                })->values();
            });

        // Helper to format costs with currency conversion
        $formatCosts = function ($costCollection) use ($currency, $currencyRate, $domain) {
            return $costCollection->map(function ($cost) use ($currency, $currencyRate, $domain) {
                $firstItemConverted = CurrencyService::convertFromUSDWithRate(
                    $cost->first_item_cost,
                    $currency,
                    $currencyRate
                );
                $additionalItemConverted = CurrencyService::convertFromUSDWithRate(
                    $cost->additional_item_cost,
                    $currency,
                    $currencyRate
                );

                $minDays = $cost->delivery_min_days ?? null;
                $maxDays = $cost->delivery_max_days ?? null;
                $deliveryNote = $cost->delivery_note ?? null;

                $deliveryText = null;
                if (!is_null($minDays) && !is_null($maxDays)) {
                    $deliveryText = $minDays == $maxDays
                        ? "{$minDays} days"
                        : "{$minDays} - {$maxDays} days";
                } elseif (!is_null($minDays)) {
                    $deliveryText = "{$minDays}+ days";
                } elseif (!is_null($maxDays)) {
                    $deliveryText = "Up to {$maxDays} days";
                }
                if (!$deliveryText && $deliveryNote) {
                    $deliveryText = $deliveryNote;
                }

                return [
                    'product_type' => $cost->product_type,
                    'first_item' => CurrencyService::formatPrice($firstItemConverted, $currency, $domain),
                    'additional_item' => CurrencyService::formatPrice($additionalItemConverted, $currency, $domain),
                    'first_item_raw' => $firstItemConverted,
                    'additional_item_raw' => $additionalItemConverted,
                    'delivery_text' => $deliveryText,
                ];
            });
        };

        // Format shipping costs cho khu vực chính của domain
        $formattedCosts = $formatCosts(
            $shippingCosts->where('region', $region)
        );

        // Gom nhóm tất cả khu vực (bao gồm domain chỉ định + general)
        $allShippingCosts = $shippingCosts->groupBy('region');

        $allFormattedCosts = $allShippingCosts->map(function ($costs) use ($formatCosts) {
            return $formatCosts($costs);
        })->filter(function ($costs) {
            return $costs->isNotEmpty();
        });

        // Region display names
        $regionNames = [
            'US' => 'United States',
            'UK' => 'United Kingdom',
            'CA' => 'Canada',
            'MX' => 'Mexico',
            'EU' => 'Europe',
        ];

        $regionName = $regionNames[$region] ?? $region;

        return view('shipping-delivery.index', compact(
            'domain',
            'currency',
            'region',
            'regionName',
            'formattedCosts',
            'shippingCosts',
            'allFormattedCosts',
            'regionNames'
        ));
    }

    /**
     * Get region from countries array
     */
    private function getRegionFromCountries(array $countries, ?string $defaultRegion = null): ?string
    {
        $countryToRegion = [
            'US' => 'US',
            'USA' => 'US',
            'GB' => 'UK',
            'GBR' => 'UK',
            'UK' => 'UK',
            'CA' => 'CA',
            'CAN' => 'CA',
            'MX' => 'MX',
            'MEX' => 'MX',
        ];

        // Map EU countries to Europe (EU)
        $euCountries = [
            'AL',
            'AD',
            'AM',
            'AT',
            'AZ',
            'BY',
            'BE',
            'BA',
            'BG',
            'CH',
            'CY',
            'CZ',
            'DE',
            'DK',
            'EE',
            'ES',
            'FI',
            'FO',
            'FR',
            'GB',
            'GE',
            'GI',
            'GR',
            'HR',
            'HU',
            'IE',
            'IS',
            'IT',
            'LI',
            'LT',
            'LU',
            'LV',
            'MC',
            'MD',
            'ME',
            'MK',
            'MT',
            'NL',
            'NO',
            'PL',
            'PT',
            'RO',
            'RS',
            'RU',
            'SE',
            'SI',
            'SJ',
            'SK',
            'SM',
            'TR',
            'UA',
            'VA'
        ];

        foreach ($countries as $country) {
            $countryUpper = strtoupper($country);
            if (isset($countryToRegion[$countryUpper])) {
                return $countryToRegion[$countryUpper];
            }
            if (in_array($countryUpper, $euCountries, true)) {
                return 'EU';
            }
        }

        return $defaultRegion;
    }

    /**
     * Get region from zone name
     */
    private function getRegionFromZoneName(string $zoneName, ?string $defaultRegion = null): ?string
    {
        $zoneNameLower = strtolower($zoneName);

        // Check for Europe
        if (
            strpos($zoneNameLower, 'europe') !== false ||
            strpos($zoneNameLower, 'eu') !== false
        ) {
            return 'EU';
        }

        // Check for UK
        if (
            strpos($zoneNameLower, 'united kingdom') !== false ||
            strpos($zoneNameLower, 'uk') !== false ||
            strpos($zoneNameLower, 'britain') !== false
        ) {
            return 'UK';
        }

        // Check for Canada
        if (
            strpos($zoneNameLower, 'canada') !== false ||
            strpos($zoneNameLower, 'ca') !== false
        ) {
            return 'CA';
        }

        // Check for Mexico
        if (
            strpos($zoneNameLower, 'mexico') !== false ||
            strpos($zoneNameLower, 'mx') !== false
        ) {
            return 'MX';
        }

        // Check for US (should be last to avoid false positives)
        if (
            strpos($zoneNameLower, 'united states') !== false ||
            strpos($zoneNameLower, 'usa') !== false ||
            strpos($zoneNameLower, 'us') !== false
        ) {
            return 'US';
        }

        return $defaultRegion;
    }
}
