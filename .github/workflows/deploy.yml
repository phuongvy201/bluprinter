- name: Deploy to EC2
  run: |
    ssh -i ~/.ssh/id_ed25519 ec2-user@3.107.252.204 << 'EOF'
      set -e
      PROJECT_PATH=/var/www/html
      WEB_USER=nginx
      cd $PROJECT_PATH

      # ðŸ”§ Fix dubious ownership (cháº¡y dÆ°á»›i ec2-user lÃ  Ä‘á»§)
      git config --global --add safe.directory $PROJECT_PATH

      # ðŸ”‘ Äáº£m báº£o owner lÃ  ec2-user (deploy user), group lÃ  nginx
      echo "ðŸ”‘ Fixing ownership (ec2-user:nginx)..."
      sudo chown -R ec2-user:$WEB_USER $PROJECT_PATH

      # ðŸ”„ Git pull/reset - cháº¡y dÆ°á»›i ec2-user (cÃ³ quyá»n full)
      echo "ðŸ”„ Pulling latest code..."
      git fetch origin main
      git reset --hard origin/main

      # ðŸ“¦ Composer install - cháº¡y dÆ°á»›i ec2-user (composer thÆ°á»ng náº±m trong /usr/local/bin, á»•n)
      echo "ðŸ“¦ Installing dependencies..."
      composer install --no-dev --optimize-autoloader --no-interaction

      # ðŸ—„ Laravel commands - cÃ³ thá»ƒ cháº¡y dÆ°á»›i ec2-user vÃ¬ storage Ä‘Ã£ group writable
      echo "ðŸ—„ Running migrations..."
      php artisan migrate --force

      echo "ðŸ§¹ Clearing & optimizing cache..."
      php artisan optimize:clear
      php artisan optimize

      # ðŸ” Äáº£m báº£o storage & cache directories group writable
      echo "ðŸ” Fixing storage permissions..."
      sudo chmod -R 775 $PROJECT_PATH/storage $PROJECT_PATH/bootstrap/cache

      # ðŸš€ Restart services
      echo "ðŸš€ Restarting PHP-FPM and Nginx..."
      sudo systemctl restart php-fpm
      sudo systemctl restart nginx

      echo "âœ… Deployment completed successfully!"
    EOF
